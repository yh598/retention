from pyspark.sql.types import StructType, StructField, StringType, LongType, TimestampType, BinaryType
from pyspark.sql import functions as F

# Set your path
path = "/Volumes/prod_adb/default/synapse_volume/raw/surveyspeechextraction/"

# Define schema
schema = StructType([
    StructField("path", StringType(), False),
    StructField("modificationTime", TimestampType(), False),
    StructField("length", LongType(), False),
    StructField("content", BinaryType(), True)
])

# Read files with schema
df = spark.read.format("binaryfile").option("pathGlobFilter", "*.zip").schema(schema).load(path)

# Extract FOLDER name (not file name)
# Example: /Volumes/prod_adb/.../Sagility/xxx.zip â†’ 'Sagility'
df = df.withColumn("folder", F.element_at(F.split("path", "/"), -2))

# Group by folder and sum size
space_by_folder = df.groupBy("folder").agg(F.sum("length").alias("total_bytes"))

# Optional: Convert bytes to MB
space_by_folder = space_by_folder.withColumn("total_mb", F.round(space_by_folder["total_bytes"] / (1024 * 1024), 2))

# Display
display(space_by_folder)